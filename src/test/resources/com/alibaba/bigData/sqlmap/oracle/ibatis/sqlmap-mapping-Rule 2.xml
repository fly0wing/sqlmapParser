<?xml version='1.0' encoding="gb2312"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
    "http://www.ibatis.com/dtd/sql-map-2.dtd">

	<!-- WARNING: This is an autogenerated file -->

<sqlMap namespace="dcms.rule">
	<typeAlias alias="Rule" type="com.alibaba.china.cmshollywood.dcms.dal.dataobject.Rule"/>
	<resultMap id="Rule-result" class="Rule">
		<result property="id" 				javaType="java.lang.Long" 	column="ID" />
		<result property="name" 			javaType="java.lang.String" column="NAME" />
		<result property="catalogId" 		javaType="java.lang.Long" 	column="CATALOG_ID" />
		<result property="memberObject.id" 	javaType="java.lang.Long" 	column="MEMBER_OBJECT_ID" />
		<result property="templateId" 		javaType="java.lang.Long" 	column="TEMPLATE_ID" />
		<result property="status" 			javaType="java.lang.String" column="STATUS" />
		<result property="author" 			javaType="java.lang.String" column="AUTHOR" />
		<result property="gmtStart" 		javaType="java.sql.Timestamp" column="GMT_START" />
		<result property="gmtEnd" 			javaType="java.sql.Timestamp" column="GMT_END" />
		<result property="gmtCreate" 		javaType="java.sql.Timestamp" column="GMT_CREATE" />
		<result property="gmtModified" 		javaType="java.sql.Timestamp" column="GMT_MODIFIED" />
		<result property="online" 			javaType="java.lang.String" 		column="R_ONLINE" />
		<result property="templateVersionId" 		javaType="java.lang.Long" 	column="TPL_VERSION_ID" />
	</resultMap>
	
	<sql id="rows">  
	    	ID,
			NAME,
			CATALOG_ID,
			GMT_START,
			GMT_END,
			MEMBER_OBJECT_ID,
			TEMPLATE_ID,
			AUTHOR,
			STATUS,
			GMT_CREATE,
			GMT_MODIFIED,
			R_ONLINE,
			TPL_VERSION_ID
	</sql>
	
	<select id="getRuleById" resultClass="Rule" parameterClass="java.lang.Long"
		resultMap="Rule-result">
		SELECT <include refid="rows"/> FROM DCMS_RULE WHERE ID=#ID#
    </select>

	<select id="getRuleByName" parameterClass="java.lang.String"
		resultMap="Rule-result">
		SELECT <include refid="rows"/> FROM DCMS_RULE WHERE NAME=#NAME#
    </select>
    
	<select id="searchEquals" parameterClass="Rule"
		resultMap="Rule-result">
		SELECT <include refid="rows"/> FROM DCMS_RULE
		<dynamic prepend="WHERE">
			<isGreaterThan prepend="AND" property="id" compareValue="0">
			 	ID = #id#
			</isGreaterThan>
			<isLessEqual property="id" compareValue="0">
				<isNotEmpty prepend="AND" property="name">
				 	NAME = #name#
				</isNotEmpty>
				<isGreaterThan prepend="AND" property="catalogId" compareValue="0">
				 	CATALOG_ID = #catalogId#
				</isGreaterThan>
				<isNotEmpty prepend="AND" property="author">
				 	AUTHOR = #author#
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="status">
				 	STATUS = #status#
				</isNotEmpty>
			</isLessEqual>
		</dynamic>
		ORDER BY GMT_MODIFIED DESC
    </select>
    
    <select id="searchLike" parameterClass="Rule"
		resultMap="Rule-result">
		SELECT <include refid="rows"/> FROM DCMS_RULE
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="name">
			 	NAME like '%#name#%'
			</isNotEmpty>
			<isGreaterThan prepend="AND" property="catalogId" compareValue="0">
			 	CATALOG_ID = #catalogId#
			</isGreaterThan>
			<isNotEmpty prepend="AND" property="author">
			 	AUTHOR like '%#author#%'
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="status">
			 	STATUS = #status#
			</isNotEmpty>
		</dynamic>
		ORDER BY GMT_MODIFIED DESC 
    </select>
    
	<insert id="createRule" parameterClass="Rule">
		<selectKey resultClass="java.lang.Long" keyProperty="id">
			SELECT SEQ_DCMS_RULE.NEXTVAL AS id FROM DUAL
		</selectKey>
		INSERT INTO
			DCMS_RULE(ID,NAME,CATALOG_ID,GMT_START,GMT_END,MEMBER_OBJECT_ID,TEMPLATE_ID,AUTHOR,STATUS,GMT_CREATE,GMT_MODIFIED,R_ONLINE,TPL_VERSION_ID)
			VALUES	 (#id#,#name#,#catalogId#,#gmtStart#,#gmtEnd#,#memberObject.id#,#templateId#,#author#,#status#,SYSDATE,SYSDATE,#online#,#templateVersionId#)
	</insert>
	
	
	<update id="updateRule" parameterClass="Rule">
		UPDATE DCMS_RULE SET GMT_MODIFIED = SYSDATE
			 <isNotEmpty prepend="," property="name" >
			 	NAME = #name#
			 </isNotEmpty>
		     <isNotEmpty prepend="," property="catalogId" >
		        CATALOG_ID = #catalogId#
		     </isNotEmpty>
		     <isNotEmpty prepend="," property="gmtStart" >
		        GMT_START = #gmtStart#
		     </isNotEmpty>
		     <isNotEmpty prepend="," property="gmtEnd" >
		        GMT_END = #gmtEnd#
		     </isNotEmpty>
		     <isNotEmpty prepend="," property="status" >
		        STATUS = #status#
		     </isNotEmpty>
		     <isGreaterThan prepend="," property="templateId" compareValue="0">
		        TEMPLATE_ID = #templateId#
		     </isGreaterThan>
		     <isGreaterThan prepend="," property="templateVersionId" compareValue="0">
		        TPL_VERSION_ID = #templateVersionId#
		     </isGreaterThan>
		     <isNotEmpty prepend="," property="online" >
		        R_ONLINE = #online#
		     </isNotEmpty>
		     <isNotNull property="memberObject" >
		        <isNotEmpty prepend="," property="memberObject.id" >
		        	MEMBER_OBJECT_ID = #memberObject.id#
		     	</isNotEmpty>
		     </isNotNull>
		 WHERE ID=#id#
	</update>
	
	<delete id="deleteRule" parameterClass="Rule">
		DELETE FROM DCMS_RULE WHERE
				<isNotEmpty property="id"> 
			    	ID = #id#
				</isNotEmpty>
				<isEmpty property="id">
					<isNotEmpty property="name"> 
				    	NAME = #name#
					</isNotEmpty>
				</isEmpty>
	</delete>
	
	<select id="getRulesByPositionId" parameterClass="java.lang.Long" resultMap="Rule-result">
		SELECT R.*
		FROM DCMS_POSITION_RULE PR, DCMS_RULE R WHERE PR.RULE_ID=R.ID AND POSITION_ID = #pid# ORDER BY pr.priority ASC
	</select>
	
	
	 <select id="MS-SELECT-RULE-BY-CODE-CATALOGID-COUNT" resultClass="java.lang.Long"><![CDATA[
        select count(*) from DCMS_RULE 
            ]]>
       		where DCMS_RULE.GMT_END>SYSDATE AND STATUS!='disable'
	        <isNotEmpty prepend="AND" property="name"> DCMS_RULE.NAME like '%' || #name# || '%' </isNotEmpty>
	          <isNotNull prepend="AND" property="catalogId">
					ID in (SELECT cr.RESOURCE_ID FROM CMS_RESOURCE_CATALOG_V2  cr where cr.RESOURCE_TYPE='rule'
					 and  cr.CATALOG_ID in 
					 <iterate property="catalogId" open="(" close=")" conjunction=",">
		                      #catalogId[]#
		            </iterate>
					)
	               </isNotNull>	
	        <isNotEmpty prepend="AND" property="id"> 
                 DCMS_RULE.ID not in 
                 <iterate  property="id" open="(" close=")" conjunction=",">
			       #id[]#
		          </iterate>
        </isNotEmpty>
    </select>
    
    <select id="MS-SELECT-TEMPLATE-BY-TYPE-CODE-CATALOGID" resultMap="Rule-result">
      <![CDATA[
        select
            *
        from
            (
            select
                t.*,rownum as myrow
            from
                (select * from DCMS_RULE  
                 ]]>
                where DCMS_RULE.GMT_END>SYSDATE AND STATUS!='disable'
                <isNotEmpty prepend="AND" property="name"> DCMS_RULE.NAME like '%' || #name# || '%'</isNotEmpty>
                <isNotNull prepend="AND" property="catalogId">
					ID in (SELECT cr.RESOURCE_ID FROM CMS_RESOURCE_CATALOG_V2  cr where cr.RESOURCE_TYPE='rule'
					 and  cr.CATALOG_ID in 
					 <iterate property="catalogId" open="(" close=")" conjunction=",">
		                      #catalogId[]#
		            </iterate>
					)
	               </isNotNull>	
                 <isNotEmpty prepend="AND" property="id"> 
                 DCMS_RULE.ID not in 
                 <iterate  property="id" open="(" close=")" conjunction=",">
			       #id[]#
		          </iterate>
                 </isNotEmpty>
                 order by GMT_MODIFIED desc) t
            where
             <![CDATA[
                rownum<=#maxvalue#
                 ]]>
            )
        where
            myrow>#minvalue#
   
    </select>
    
    <select id="getRuleByIdArray" resultMap="Rule-result">
		SELECT <include refid="rows"/> FROM DCMS_RULE WHERE ID in
		  <iterate  property="ruleIdArray" open="(" close=")" conjunction=",">
			       #ruleIdArray[]#
		    </iterate>
    </select>
    
    
    <select id="searchRuleList" resultMap="Rule-result">

			SELECT 	R.*
			FROM DCMS_RULE R,CMS_USER U WHERE R.AUTHOR = U.USER_ID
		      	<isGreaterThan prepend="AND" property="ruleId" compareValue="0">
					R.ID = #ruleId#
				</isGreaterThan>
				<isLessEqual property="ruleId" compareValue="0">
					<isNotEmpty prepend="AND" property="endTimeValid"> R.GMT_END>SYSDATE </isNotEmpty>   
					<isNotEmpty prepend="AND" property="name"> Lower(R.NAME) like '%' || Lower(#name#) || '%'</isNotEmpty>
					<isNotEmpty prepend="AND" property="status"> R.STATUS =#status#</isNotEmpty>
					<isEmpty prepend="AND"  property="status">
						<![CDATA[ R.STATUS <> 'disable' ]]>
					</isEmpty>
					<isNotEmpty prepend="AND" property="author"> (Lower(R.AUTHOR) like '%' || Lower(#author#) || '%' OR Lower(U.FULL_NAME) LIKE '%'||Lower(#author#)||'%')</isNotEmpty>
					
				  <isNotNull prepend="AND" property="siteId">
					R.ID in (SELECT RESOURCE_ID FROM CMS_RESOURCE_SITE where RESOURCE_TYPE='rule'
					 and  SITE_ID in 
					 <iterate property="siteId" open="(" close=")" conjunction=",">
		                      #siteId[]#
		            </iterate>
					)
			      </isNotNull>
			      
					<isNotNull prepend="AND" property="catalogId">
					R.ID in (SELECT cr.RESOURCE_ID FROM CMS_RESOURCE_CATALOG_V2  cr where cr.RESOURCE_TYPE='rule'
					 and  cr.CATALOG_ID in 
					 <iterate property="catalogId" open="(" close=")" conjunction=",">
		                      #catalogId[]#
		            </iterate>
					)
	               </isNotNull>
				</isLessEqual>
			
	</select>
	
	
	<select id="getRuleListByIdsOrStatus" resultMap="Rule-result">
		SELECT <include refid="rows"/> FROM DCMS_RULE WHERE ID IN 
			<iterate property="idList" open="(" close=")" conjunction=",">
				#idList[]#
			</iterate>
			<isNotEmpty prepend="AND" property="status"> STATUS =#status#</isNotEmpty>
	</select>

	<select id="getRuleListByTemplateId" resultMap="Rule-result">
		SELECT <include refid="rows"/> FROM DCMS_RULE WHERE TEMPLATE_ID=#templateId#
	</select>
	
	<select id="getRulesByTemplateId" resultMap="Rule-result">
		SELECT <include refid="rows"/> FROM DCMS_RULE WHERE TEMPLATE_ID = #tid#
	</select>

    <select id="getExpiredRulesByPeriod" resultMap="Rule-result">
      <![CDATA[
        select
            *
        from
            (
            select
                t.*,rownum as myrow
            from
                (select * from DCMS_RULE  
                 where DCMS_RULE.GMT_END < #now# and STATUS!='disable'
                 ]]>
                <isNotEmpty prepend="AND" property="beginDate"> 
                	DCMS_RULE.GMT_END >= #beginDate#
                </isNotEmpty>
                <isNotEmpty prepend="AND" property="endDate"> 
                	DCMS_RULE.GMT_END <![CDATA[<=]]> #endDate#
                </isNotEmpty>                
             <![CDATA[
                 order by GMT_END desc) t
            where             
                rownum<=#end#
            )
        where
            myrow>#begin#
            ]]>   
    </select>	
</sqlMap>
