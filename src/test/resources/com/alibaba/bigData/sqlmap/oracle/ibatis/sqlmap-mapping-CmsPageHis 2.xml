<?xml version='1.0' encoding="gb2312"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
    "http://www.ibatis.com/dtd/sql-map-2.dtd">

<!-- WARNING: This is an autogenerated file -->

<sqlMap namespace="cms_CmsPageHis">        
        
    <resultMap class="CmsPageHis" id="CmsPageHis-result" >
        <result property="gmtCreate"	javaType="java.sql.Timestamp"	column="GMT_CREATE" />
        <result property="gmtModified"	javaType="java.sql.Timestamp"	column="GMT_MODIFIED" />
        <result property="id"			javaType="java.lang.Long"		column="ID" />
        <result property="catalogId"	javaType="java.lang.Long"		column="CATALOG_ID" />
        <result property="title"		javaType="java.lang.String"		column="TITLE" />
        <result property="keywords"		javaType="java.lang.String"		column="KEYWORDS" />
        <result property="header"		javaType="java.lang.String"		column="HEADER" />
        <result property="style"		javaType="java.lang.String"		column="STYLE" />
        <result property="description"	javaType="java.lang.String"		column="DESCRIPTION" />
        <result property="status"		javaType="java.lang.String"		column="STATUS" />
		<result property="specificUrl"	javaType="java.lang.String"		column="SPECIFIC_URL" />
		<result property="domainPathId"	javaType="java.lang.Long"		column="DOMAIN_PATH_ID" />
		<result property="footer"		javaType="java.lang.String"		column="FOOTER" />
		<result property="intervalTime" javaType="java.lang.String"		column="INTERVAL_TIME" />
		<result property="pageType"     javaType="java.lang.String"		column="PAGE_TYPE" />
		<result property="tag"     		javaType="java.lang.String"		column="TAG" />
		<result property="cleanCreateDate"    javaType="java.sql.Timestamp"	column="CLEAN_CREATE_DATE" />
		<result property="cleanModifyDate"    javaType="java.sql.Timestamp"	column="CLEAN_MODIFY_DATE" />
		<result property="cleanStatus"  javaType="java.lang.Integer"	column="CLEAN_STATUS" />
    </resultMap>

    <resultMap class="CmsPageHis" id="CmsPageHisForClean-result" >
        <result property="id"			javaType="java.lang.Long"		column="ID" />
		<result property="specificUrl"	javaType="java.lang.String"		column="SPECIFIC_URL" />
		<result property="cleanStatus"  javaType="java.lang.Integer"	column="CLEAN_STATUS" />
    </resultMap>

    <select id="getCmsPage" resultClass="CmsPageHis"  parameterClass="map" resultMap="CmsPageHis-result" >
      select    *      from CMS_PAGE_HIS
    <dynamic prepend="where" >
      <isNotNull prepend="and" property="id" >
        ID = #id#
      </isNotNull>
      <isNotNull prepend="and" property="cleanStatus" >
        CLEAN_STATUS = #cleanStatus#
      </isNotNull>
    </dynamic>
        ORDER by ID
    </select>

	<select id="queryCmsPageForClean"  resultMap="CmsPageHisForClean-result" parameterClass="map">
select p.id,dm.domain || dp.context_path || p.specific_url as SPECIFIC_URL,p.CLEAN_STATUS from cms_page_his p, cms_domain_path dp, cms_domain dm where p.domain_path_id = dp.id (+) and dp.domain_id = dm.id(+)
            <dynamic >
			  <isNotEmpty prepend="AND" property="pageType" >	
			        p.PAGE_TYPE = #pageType#
			  </isNotEmpty>	
			  <isNotNull prepend="AND" property="domain">
				 dm.domain in
					<iterate property="domain" open="(" close=")" conjunction=",">
						                      #domain[]#
		            </iterate>
		      </isNotNull>
			  <isNotEmpty prepend="AND" property="rownumLimit" >
				      <![CDATA[
				rownum <= #rownumLimit#
				      ]]>

			  </isNotEmpty>
			  <isNotEmpty prepend="AND" property="endTime" >	
			  		<![CDATA[
			        p.GMT_MODIFIED <=TO_DATE(#endTime#,'YYYY-MM-DD HH24:MI:SS')
			        ]]>	
			  </isNotEmpty>	
		      
            </dynamic>
    </select>


    <insert id="insertCmsPage" parameterClass="CmsPageHis" >
		<![CDATA[
            insert into CMS_PAGE_HIS
              (GMT_CREATE  , GMT_MODIFIED  , ID  , CATALOG_ID  , TITLE  , KEYWORDS  , HEADER  , STYLE  , DESCRIPTION  , STATUS ,SPECIFIC_URL,DOMAIN_PATH_ID,FOOTER,INTERVAL_TIME,PAGE_TYPE,TAG,CLEAN_CREATE_DATE,CLEAN_MODIFY_DATE,CLEAN_STATUS)
            values
              (#gmtCreate#  , #gmtModified#  , #id#  , #catalogId#  , #title#  , #keywords#  , #header#  , #style#  , #description#  , #status# ,#specificUrl#,#domainPathId#,#footer#,#intervalTime#,#pageType#,#tag#,SYSDATE,SYSDATE,#cleanStatus#)
        ]]>
    </insert>

    <delete id="deleteCmsPage" parameterClass="java.lang.Long"  >
        <![CDATA[
            delete from CMS_PAGE_HIS where ID = #value# 
        ]]>
    </delete>

    <update id="updateCmsPageById" parameterClass="CmsPageHis" >
            update
                        CMS_PAGE_HIS
            set
                    CLEAN_MODIFY_DATE = sysdate
		<dynamic prepend = "">
                <isNotNull property = "cleanStatus" prepend = ",">CLEAN_STATUS = #cleanStatus#</isNotNull>
        </dynamic>
		where ID = #id#			
    </update>

	<select id="MS-COUNT-CMSPAGE-BY-SEARCH"  resultClass="java.lang.Integer" parameterClass="map">
            SELECT count(*) FROM CMS_PAGE_HIS 
            <dynamic prepend="WHERE">
		      <isEmpty property = "specialUrl">
				  <isNotEmpty prepend="AND" property="title" >
			        title like '%'||#title#||'%'
			      </isNotEmpty>
				  <isNotNull prepend="AND" property="catalogId">
					ID in (SELECT RESOURCE_ID FROM CMS_RESOURCE_CATALOG_V2 where RESOURCE_TYPE='page'
					 and  CATALOG_ID in 
					 <iterate property="catalogId" open="(" close=")" conjunction=",">
		                      #catalogId[]#
		            </iterate>
					)
			      </isNotNull>		      
			      <isNotEmpty prepend="AND" property="keywords" >
			        KEYWORDS like '%'||#keywords#||'%'
			      </isNotEmpty>
				  <isGreaterThan prepend="AND" property="domainId" compareValue="0">
					DOMAIN_PATH_ID in (SELECT ID FROM CMS_DOMAIN_PATH WHERE DOMAIN_ID=#domainId#)
			      </isGreaterThan>
			   </isEmpty>
			  <isNotEmpty prepend="AND" property = "specialUrl">
			  	 SPECIFIC_URL like '%'||#specialUrl#||'%'
			  </isNotEmpty>
			  <isNotEmpty prepend="AND" property="pageType" >	
			        PAGE_TYPE = #pageType#
			  </isNotEmpty>				      
            </dynamic>
    </select>
	<select id="MS-SELECT-CMSPAGE-BY-SEARCH"  resultMap="CmsPageHis-result" parameterClass="map">
	  <![CDATA[
      SELECT * FROM (
         SELECT A.*,ROWNUM RN FROM (
            SELECT * FROM CMS_PAGE_HIS 
      ]]>
            <dynamic prepend="WHERE">
		     <isEmpty property = "specialUrl">
				  <isNotEmpty prepend="AND" property="title" >
			        title like '%'||#title#||'%'
			      </isNotEmpty>
				  <isNotNull prepend="AND" property="catalogId">
					ID in (SELECT RESOURCE_ID FROM CMS_RESOURCE_CATALOG_V2 where RESOURCE_TYPE='page'
					 and  CATALOG_ID in 
					 <iterate property="catalogId" open="(" close=")" conjunction=",">
		                      #catalogId[]#
		            </iterate>
					)
			      </isNotNull>
			      <isNotEmpty prepend="AND" property="keywords" >
			        KEYWORDS like '%'||#keywords#||'%'
			      </isNotEmpty>
				  <isGreaterThan prepend="AND" property="domainId" compareValue="0">
					DOMAIN_PATH_ID in (SELECT ID FROM CMS_DOMAIN_PATH WHERE DOMAIN_ID=#domainId#)
			      </isGreaterThan>
			  </isEmpty>
			  <isNotEmpty prepend="AND" property = "specialUrl">
			  	SPECIFIC_URL like '%'||#specialUrl#||'%'
			  </isNotEmpty>	
			  <isNotEmpty prepend="AND" property="pageType" >	
			        PAGE_TYPE = #pageType#
			  </isNotEmpty>			      
            </dynamic>
      <![CDATA[
            ORDER BY ID DESC
         ) A WHERE ROWNUM <= #offset# + #length#
      ) WHERE RN > #offset#
      ]]>
    </select>
    


    
</sqlMap>
