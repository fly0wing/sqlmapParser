<?xml version='1.0' encoding="gb2312"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
    "http://www.ibatis.com/dtd/sql-map-2.dtd">

	<!-- WARNING: This is an autogenerated file -->

<sqlMap namespace="dcms.onlinerule">

	<resultMap id="OnlineRule-result" class="OnlineRule">
		<result property="id" 				javaType="java.lang.Long" 	column="ID" />
		<result property="ruleId" 			javaType="java.lang.Long" 	column="RULE_ID" />
		<result property="onlineMemberObject.memberObjectId" 	javaType="java.lang.Long" 	column="MEMBER_OBJECT_ID" />
		<result property="templateId" 		javaType="java.lang.Long" 	column="TEMPLATE_ID" />
		<result property="templateVersionId" 		javaType="java.lang.Long" 	column="TPL_VERSION_ID" />
		<result property="gmtStart" 		javaType="java.sql.Timestamp" column="GMT_START" />
		<result property="gmtEnd" 			javaType="java.sql.Timestamp" column="GMT_END" />
		<result property="gmtCreate" 		javaType="java.sql.Timestamp" column="GMT_CREATE" />
		<result property="gmtModified" 		javaType="java.sql.Timestamp" column="GMT_MODIFIED" />
	</resultMap>
	
	<sql id="rows">  
	    	ID,
	    	RULE_ID,
			GMT_START,
			GMT_END,
			GMT_CREATE,
			GMT_MODIFIED,
			MEMBER_OBJECT_ID,
			TEMPLATE_ID,
			TPL_VERSION_ID
	</sql>
	
	<sql id="table">ONLINE_RULE</sql>
	
	<insert id="createOnlineRule" parameterClass="OnlineRule">
		<selectKey resultClass="java.lang.Long" keyProperty="id">
			SELECT SEQ_ONLINE_RULE.NEXTVAL AS id FROM DUAL
		</selectKey>
		INSERT INTO
			ONLINE_RULE(ID,RULE_ID,GMT_START,GMT_END,MEMBER_OBJECT_ID,TEMPLATE_ID,GMT_CREATE,GMT_MODIFIED,TPL_VERSION_ID)
			VALUES	 (#id#,#ruleId#,#gmtStart#,#gmtEnd#,#onlineMemberObject.memberObjectId#,#templateId#,SYSDATE,SYSDATE,#templateVersionId#)
	</insert>
	
	<update id="updateOnlineRule" parameterClass="OnlineRule">
		UPDATE <include refid="table"/> SET GMT_MODIFIED = SYSDATE
		     <isNotEmpty prepend="," property="gmtStart" >
		        GMT_START = #gmtStart#
		     </isNotEmpty>
		     <isNotEmpty prepend="," property="gmtEnd" >
		        GMT_END = #gmtEnd#
		     </isNotEmpty>
		     <isNotEmpty prepend="," property="templateId" >
		        TEMPLATE_ID = #templateId#
		     </isNotEmpty>
		     <isNotEmpty prepend="," property="templateVersionId" >
		        TPL_VERSION_ID = #templateVersionId#
		     </isNotEmpty>
		     <isNotNull property="onlineMemberObject" >
		     	<isGreaterThan prepend="," property="onlineMemberObject.memberObjectId" compareValue="0">
		        	MEMBER_OBJECT_ID = #onlineMemberObject.memberObjectId#
		     	</isGreaterThan>
		     </isNotNull>
		 WHERE RULE_ID=#ruleId#
	</update>
	
	
	<select id="getOnlineRuleByRuleId" resultClass="OnlineRule" parameterClass="java.lang.Long"
		resultMap="OnlineRule-result">
		SELECT <include refid="rows"/> FROM <include refid="table"/> WHERE RULE_ID=#ID#
    </select>

	<select id="getOnlineRulesByIds" resultMap="OnlineRule-result">
		SELECT <include refid="rows"/> FROM <include refid="table"/> WHERE ID in
		  	<iterate  property="ids" open="(" close=")" conjunction=",">
			       #ids[]#
		    </iterate>
    </select>
    
    <select id="getOnlineRulesByOnlinePosId" resultMap="OnlineRule-result">
		SELECT A.*,B.PRIORITY FROM ONLINE_RULE A,ONLINE_POS_RULE B
		  WHERE A.RULE_ID = B.RULE_ID AND B.POSITION_ID = #posId#
		  ORDER BY B.PRIORITY ASC
    </select>
    
  	<resultMap id="onlineRule-to-Snapshots-result" class="Snapshots">
        <result property="versionId" column="VERSION_ID" jdbcType="NUMERIC" javaType="java.lang.Long"/>
        <result property="resourceId" column="RESOURCE_ID" jdbcType="NUMERIC" javaType="java.lang.String"/>
  </resultMap>   
   
	<select id="iterateTemplateVersionIds" resultMap="onlineRule-to-Snapshots-result" resultClass="Snapshots" parameterClass="java.util.Map">
       	   <![CDATA[
            SELECT * FROM (
             SELECT A.*,ROWNUM RN FROM ( 
                SELECT TPL_VERSION_ID as VERSION_ID,
                       TEMPLATE_ID as  RESOURCE_ID
                FROM ONLINE_RULE a
           	    GROUP BY TPL_VERSION_ID, TEMPLATE_ID
                ORDER BY TPL_VERSION_ID
             ) A WHERE ROWNUM <= #offset# + #length#
            ) WHERE RN > #offset#
      	   ]]>	
   </select>
        
</sqlMap>
